<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Realms: Final Prototype</title>
    <!-- Pixel Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood-dark: #5c3c1e;
            --wood-light: #8b5a2b;
            --wood-highlight: #a6703c;
            --parchment: #fcf5c5;
            --parchment-shadow: #e0d5a0;
            --text-color: #42200b;
            --ui-bg: #ffcd85;
            --hp-green: #6dad52;
            --hp-red: #d94e41;
            --mp-blue: #4fa4b8;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #1a1a1a;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Game Container --- */
        #game-window {
            width: 900px;
            height: 650px;
            background-color: #6dad52;
            border: 12px solid var(--wood-dark);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Scene Area --- */
        #scene {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 40%, #6dad52 40%, #5a9c42 100%);
            overflow: hidden;
        }

        /* Background Clouds */
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.8);
            border-radius: 50px;
            animation: moveCloud linear infinite;
        }
        @keyframes moveCloud {
            from { left: -150px; }
            to { left: 100%; }
        }

        /* Turn Indicator Arrow */
        #turn-arrow {
            position: absolute;
            width: 40px;
            height: 40px;
            fill: gold;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 50;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: bounceArrow 1s infinite;
            display: none; /* Hidden initially */
        }
        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Character/Enemy Containers */
        .unit {
            position: absolute;
            width: 110px;
            height: 110px;
            transition: filter 0.2s, transform 0.2s;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            cursor: pointer;
            z-index: 10;
        }

        /* Positions */
        #hero-1 { bottom: 180px; left: 120px; } /* Solarion */
        #hero-2 { bottom: 60px; left: 220px; }  /* Hydro */
        #enemy  { bottom: 120px; right: 150px; width: 140px; height: 140px; } 

        /* Sprites (SVG) */
        .sprite {
            width: 100%;
            height: 100%;
            animation: idle 2.5s infinite ease-in-out;
            overflow: visible;
        }

        @keyframes idle {
            0%, 100% { transform: scale(1, 1); }
            50% { transform: scale(1.02, 0.98) translateY(2px); }
        }

        .active-turn {
            filter: drop-shadow(0 0 8px gold) brightness(1.1);
        }

        .hit-anim {
            animation: shake 0.4s;
            filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5);
        }

        @keyframes shake {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-8px, 0); }
            40% { transform: translate(8px, 0); }
            60% { transform: translate(-8px, 0); }
            80% { transform: translate(8px, 0); }
            100% { transform: translate(0, 0); }
        }

        .dead-anim {
            filter: grayscale(100%) brightness(0.5);
            opacity: 0.6;
            transform: scale(0.9) rotate(-10deg);
        }

        /* --- UI Overlay (Stats) --- */
        .stat-bar-container {
            position: absolute;
            width: 120px;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 6px;
            border-radius: 6px;
            border: 2px solid var(--wood-light);
            text-align: center;
            z-index: 20;
            transition: opacity 0.3s;
        }

        .name-tag {
            color: white;
            font-size: 1.3rem;
            text-shadow: 1px 1px 0 #000;
            display: block;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .bar {
            height: 10px;
            background: #222;
            border: 1px solid #000;
            margin-bottom: 3px;
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.4s ease-out;
        }

        .hp-fill { background: linear-gradient(90deg, #ff6b6b, #d94e41); }
        .mp-fill { background: linear-gradient(90deg, #4fa4b8, #2c7a8b); }

        /* --- Particle System --- */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 100;
        }

        /* --- Floating Damage Text --- */
        .damage-text {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
            pointer-events: none;
            animation: floatUp 1s forwards cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 100;
            white-space: nowrap;
        }

        .crit-text { color: #ffcc00; font-size: 4rem; z-index: 101; }
        .heal-text { color: #5eff79; }
        .miss-text { color: #aaa; font-style: italic; font-size: 2rem; }

        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(10px) scale(0.5); }
            20% { opacity: 1; transform: translateY(0) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); }
        }

        /* --- Bottom HUD --- */
        #hud {
            height: 220px;
            background-color: var(--wood-dark);
            border-top: 6px solid #42200b;
            display: flex;
            padding: 15px;
            gap: 15px;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Combat Log */
        #combat-log {
            flex: 1;
            background-color: var(--parchment);
            border: 4px solid var(--wood-light);
            border-radius: 6px;
            padding: 12px;
            overflow-y: auto;
            font-size: 1.4rem;
            color: var(--text-color);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            font-family: 'VT323', monospace;
            line-height: 1.4;
        }
        
        #combat-log::-webkit-scrollbar { width: 10px; }
        #combat-log::-webkit-scrollbar-track { background: var(--wood-light); }
        #combat-log::-webkit-scrollbar-thumb { background: var(--wood-dark); border: 1px solid var(--parchment); }

        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 2px; }

        /* Action Menu */
        #action-menu {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--ui-bg);
            padding: 12px;
            border: 4px solid var(--wood-light);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        #active-char-display {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            color: var(--wood-dark);
            border-bottom: 3px double var(--wood-dark);
            padding-bottom: 5px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            flex: 1;
        }

        button {
            background: linear-gradient(to bottom, var(--wood-highlight), var(--wood-light));
            color: var(--parchment);
            border: 2px solid var(--wood-dark);
            font-family: 'VT323', monospace;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 var(--wood-dark);
            border-radius: 4px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }

        button:active { transform: translateY(4px); box-shadow: 0 0 0 var(--wood-dark); }
        button:hover { filter: brightness(1.15); }
        button:disabled {
            background: #555; color: #999; 
            box-shadow: none; cursor: not-allowed; 
            transform: translateY(4px);
            border-color: #333;
        }

        #tooltip {
            height: 25px;
            font-size: 1.2rem;
            color: var(--wood-dark);
            text-align: center;
            margin-top: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            line-height: 25px;
        }

        /* --- Overlays --- */
        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(4px);
        }

        .overlay-title {
            font-size: 5rem;
            color: white;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .overlay-subtitle {
            font-size: 2rem;
            color: var(--parchment);
            margin-bottom: 30px;
            max-width: 60%;
            text-align: center;
        }

        .big-btn {
            padding: 15px 40px;
            font-size: 2.5rem;
            background: #d94e41;
            border: 4px solid #fff;
            color: white;
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="game-window">
        
        <!-- Game Scene -->
        <div id="scene">
            <!-- Dynamic Background Elements -->
            <div class="cloud" style="top: 50px; left: 10%; width: 100px; height: 40px; opacity: 0.6; animation-duration: 40s;"></div>
            <div class="cloud" style="top: 120px; left: 60%; width: 140px; height: 50px; opacity: 0.4; animation-duration: 60s;"></div>
            <div class="cloud" style="top: 80px; left: 90%; width: 80px; height: 30px; opacity: 0.7; animation-duration: 35s;"></div>

            <!-- Turn Indicator -->
            <svg id="turn-arrow" viewBox="0 0 24 24"><path d="M12 2l-10 10h6v10h8v-10h6z"/></svg>

            <!-- Hero 1: Solarion (Fire) -->
            <div id="hero-1" class="unit" onclick="selectUnit(0)">
                <div class="stat-bar-container">
                    <span class="name-tag">Solarion</span>
                    <div class="bar"><div class="bar-fill hp-fill" style="width: 100%"></div></div>
                    <div class="bar"><div class="bar-fill mp-fill" style="width: 100%"></div></div>
                </div>
                <svg class="sprite" viewBox="0 0 100 100">
                    <defs>
                        <filter id="glow-fire" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="2" result="blur" />
                            <feComposite in="SourceGraphic" in2="blur" operator="over" />
                        </filter>
                    </defs>
                    <g filter="url(#glow-fire)">
                        <rect x="35" y="25" width="30" height="50" fill="#a02020" rx="4" /> <!-- Armor -->
                        <path d="M 35 25 L 50 10 L 65 25" fill="#d94e41" /> <!-- Pauldrons -->
                        <circle cx="50" cy="25" r="12" fill="#ffe0bd" /> <!-- Head -->
                        <rect x="35" y="20" width="30" height="8" fill="#gold" /> <!-- Crown/Helmet -->
                        <rect x="70" y="30" width="8" height="50" fill="#ddd" /> <!-- Sword Blade -->
                        <rect x="65" y="65" width="18" height="5" fill="#5c3c1e" /> <!-- Hilt -->
                        <path d="M 20 40 L 40 40 L 30 70 Z" fill="#8b5a2b" /> <!-- Shield -->
                    </g>
                </svg>
            </div>

            <!-- Hero 2: Hydro (Water) -->
            <div id="hero-2" class="unit" onclick="selectUnit(1)">
                <div class="stat-bar-container">
                    <span class="name-tag">Hydro</span>
                    <div class="bar"><div class="bar-fill hp-fill" style="width: 100%"></div></div>
                    <div class="bar"><div class="bar-fill mp-fill" style="width: 100%"></div></div>
                </div>
                <svg class="sprite" viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="robe" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4fa4b8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2c7a8b;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M 30 80 L 70 80 L 60 30 L 40 30 Z" fill="url(#robe)" /> <!-- Robe Body -->
                    <circle cx="50" cy="25" r="12" fill="#ffe0bd" /> <!-- Head -->
                    <path d="M 30 25 L 70 25 L 50 5 Z" fill="#2d5e6b" /> <!-- Hat -->
                    <rect x="75" y="30" width="4" height="60" fill="#5c3c1e" /> <!-- Staff -->
                    <circle cx="77" cy="25" r="6" fill="#8bfa" opacity="0.8">
                        <animate attributeName="opacity" values="0.6;1;0.6" duration="2s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </div>

            <!-- Enemy Unit (Dynamic) -->
            <div id="enemy" class="unit" onclick="selectUnit('enemy')">
                <div class="stat-bar-container">
                    <span class="name-tag" id="enemy-name">Enemy</span>
                    <div class="bar"><div class="bar-fill hp-fill" style="width: 100%"></div></div>
                </div>
                <div id="enemy-sprite-container" style="width:100%; height:100%;">
                    <!-- Sprite injected via JS -->
                </div>
            </div>

        </div>

        <!-- HUD -->
        <div id="hud">
            <div id="combat-log"></div>

            <div id="action-menu">
                <div id="active-char-display">Waiting...</div>
                <div class="btn-grid">
                    <button id="btn-attack" onmouseover="showTip('Basic Physical Attack')" onmouseout="clearTip()">‚öîÔ∏è Attack</button>
                    <button id="btn-skill" onmouseover="showTip('Unique Ability (Cost MP)')" onmouseout="clearTip()">‚ú® Skill</button>
                    <button id="btn-defend" onmouseover="showTip('Halve incoming damage')" onmouseout="clearTip()">üõ°Ô∏è Defend</button>
                    <button id="btn-item" onmouseover="showTip('Heal 40 HP')" onmouseout="clearTip()">üß™ Potion</button>
                </div>
                <div id="tooltip">Hover for info</div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="start-overlay" class="overlay-screen" style="display: flex;">
            <div class="overlay-title">BATTLE REALMS</div>
            <div class="overlay-subtitle">Tactical Prototype v1.0<br>Defeat 3 Waves of Enemies!</div>
            <button class="big-btn" onclick="startGame()">START GAME</button>
        </div>

        <!-- Wave Clear Overlay -->
        <div id="wave-overlay" class="overlay-screen">
            <div class="overlay-title" style="font-size: 4rem; color: gold;">WAVE CLEARED!</div>
            <div class="overlay-subtitle">Heroes rest and recover HP/MP...<br>Get ready for the next battle!</div>
            <button class="big-btn" onclick="startNextWave()">NEXT WAVE</button>
        </div>

        <!-- Game Over Overlay -->
        <div id="game-over-overlay" class="overlay-screen">
            <div id="game-over-title" class="overlay-title">VICTORY!</div>
            <div id="game-over-sub" class="overlay-subtitle">You have conquered the realms.</div>
            <button class="big-btn" onclick="location.reload()">PLAY AGAIN</button>
        </div>

    </div>

    <script>
        // --- Audio Engine (Synthesizer) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const SoundFX = {
            playTone: (freq, type, duration) => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            attack: () => {
                // Retro "Hit" noise
                SoundFX.playTone(150, 'square', 0.1);
                setTimeout(() => SoundFX.playTone(100, 'sawtooth', 0.1), 50);
            },
            fireball: () => {
                // Slide down effect
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            },
            heal: () => {
                // Rising chime
                SoundFX.playTone(400, 'sine', 0.1);
                setTimeout(() => SoundFX.playTone(600, 'sine', 0.2), 100);
                setTimeout(() => SoundFX.playTone(800, 'sine', 0.3), 200);
            },
            crit: () => {
                // High pitch ping
                SoundFX.playTone(800, 'square', 0.1);
                setTimeout(() => SoundFX.playTone(1200, 'square', 0.2), 50);
            },
            victory: () => {
                // Victory jingle
                [300, 400, 500, 600, 800].forEach((freq, i) => {
                    setTimeout(() => SoundFX.playTone(freq, 'square', 0.2), i * 150);
                });
            }
        };

        // --- Game Config & State ---
        const HEROES = [
            { 
                id: 0, name: "Solarion", type: "Fire", 
                hp: 120, maxHp: 120, mp: 50, maxMp: 50, 
                atk: 18, def: 5, spd: 10, 
                skillName: "Fireball", skillCost: 15,
                defending: false, dead: false 
            },
            { 
                id: 1, name: "Hydro", type: "Water", 
                hp: 100, maxHp: 100, mp: 80, maxMp: 80, 
                atk: 12, def: 3, spd: 12, 
                skillName: "Heal Wave", skillCost: 20,
                defending: false, dead: false 
            }
        ];

        // Wave Configuration
        const WAVES = [
            { name: "Slime Blob", type: "Water", hp: 150, atk: 12, def: 0, spriteColor: "#4fa4b8", shape: "slime" },
            { name: "Dire Wolf", type: "Nature", hp: 220, atk: 18, def: 5, spriteColor: "#654321", shape: "wolf" },
            { name: "Iron Golem", type: "Fire", hp: 350, atk: 25, def: 10, spriteColor: "#555", shape: "golem" } // Boss
        ];

        let currentWave = 0;
        let ENEMY = null;
        let currentTurnIndex = 0; // 0=Hero1, 1=Hero2, 2=Enemy
        let isPlayerTurn = false;
        let activeHeroId = null;

        // --- DOM Elements ---
        const logEl = document.getElementById('combat-log');
        const activeDisplayEl = document.getElementById('active-char-display');
        const tooltipEl = document.getElementById('tooltip');
        const turnArrow = document.getElementById('turn-arrow');
        const sceneEl = document.getElementById('scene');
        const btns = {
            attack: document.getElementById('btn-attack'),
            skill: document.getElementById('btn-skill'),
            defend: document.getElementById('btn-defend'),
            item: document.getElementById('btn-item')
        };

        // --- Initialization ---
        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            log("Game Started! Wave 1: Slime Blob approaches.", "blue");
            setupWave(0);
        }

        function setupWave(waveIdx) {
            currentWave = waveIdx;
            const data = WAVES[waveIdx];
            ENEMY = { 
                name: data.name, type: data.type, 
                hp: data.hp, maxHp: data.hp, 
                atk: data.atk, def: data.def, 
                dead: false 
            };
            
            // Render Enemy Sprite
            renderEnemySprite(data);
            
            // Reset Turns
            currentTurnIndex = -1; // Will increment to 0
            updateUI();
            nextTurn();
        }

        function renderEnemySprite(data) {
            const container = document.getElementById('enemy-sprite-container');
            let svgContent = '';
            
            if (data.shape === 'slime') {
                svgContent = `<svg class="sprite" viewBox="0 0 100 100">
                    <path d="M 20 80 Q 50 100 80 80 Q 90 60 80 40 Q 50 20 20 40 Q 10 60 20 80" fill="${data.spriteColor}" />
                    <circle cx="35" cy="45" r="5" fill="#000" /><circle cx="65" cy="45" r="5" fill="#000" />
                    <circle cx="37" cy="43" r="2" fill="#fff" /><circle cx="67" cy="43" r="2" fill="#fff" />
                </svg>`;
            } else if (data.shape === 'wolf') {
                svgContent = `<svg class="sprite" viewBox="0 0 100 100">
                    <path d="M 20 70 L 40 40 L 60 70 L 80 50 L 70 80 L 30 80 Z" fill="${data.spriteColor}" />
                    <circle cx="35" cy="55" r="3" fill="red" />
                    <path d="M 10 50 L 30 50 L 20 20 Z" fill="${data.spriteColor}" />
                </svg>`;
            } else { // Golem
                 svgContent = `<svg class="sprite" viewBox="0 0 100 100">
                    <rect x="25" y="30" width="50" height="50" rx="5" fill="${data.spriteColor}" stroke="#222" stroke-width="2"/>
                    <rect x="20" y="30" width="10" height="40" fill="#333" />
                    <rect x="70" y="30" width="10" height="40" fill="#333" />
                    <rect x="35" y="40" width="10" height="5" fill="red" class="golem-eye" />
                    <rect x="55" y="40" width="10" height="5" fill="red" class="golem-eye" />
                </svg>`;
            }
            container.innerHTML = svgContent;
            document.getElementById('enemy-name').innerText = data.name;
        }

        // --- Turn System ---
        function nextTurn() {
            // Check Win/Loss
            if (ENEMY.hp <= 0) return handleWaveClear();
            if (HEROES.every(h => h.dead)) return handleDefeat();

            currentTurnIndex++;
            if (currentTurnIndex > 2) currentTurnIndex = 0;

            // Skip Dead Heroes
            if (currentTurnIndex < 2 && HEROES[currentTurnIndex].dead) {
                nextTurn(); 
                return;
            }

            // Reset Defend
            if (currentTurnIndex < 2) HEROES[currentTurnIndex].defending = false;

            updateTurnIndicator();

            if (currentTurnIndex === 2) {
                // Enemy Turn
                isPlayerTurn = false;
                activeDisplayEl.innerText = `${ENEMY.name}'s Turn`;
                activeDisplayEl.style.color = "red";
                disableButtons(true);
                setTimeout(enemyAI, 1200);
            } else {
                // Hero Turn
                const hero = HEROES[currentTurnIndex];
                isPlayerTurn = true;
                activeHeroId = currentTurnIndex;
                
                activeDisplayEl.innerText = `${hero.name}'s Turn`;
                activeDisplayEl.style.color = hero.type === 'Fire' ? '#d94e41' : '#4fa4b8';
                
                btns.skill.innerText = `‚ú® ${hero.skillName}`;
                disableButtons(false);
                
                // Mana Check
                btns.skill.disabled = hero.mp < hero.skillCost;
            }
        }

        function updateTurnIndicator() {
            // Remove highlighting
            document.querySelectorAll('.unit').forEach(u => u.classList.remove('active-turn'));
            
            let targetEl;
            if (currentTurnIndex === 2) {
                targetEl = document.getElementById('enemy');
            } else {
                targetEl = document.getElementById(`hero-${currentTurnIndex+1}`);
            }

            targetEl.classList.add('active-turn');
            
            // Move Arrow
            turnArrow.style.display = 'block';
            const rect = targetEl.getBoundingClientRect();
            // Calculate position relative to game window
            const gameRect = document.getElementById('game-window').getBoundingClientRect();
            
            turnArrow.style.left = (rect.left - gameRect.left + 35) + 'px';
            turnArrow.style.top = (rect.top - gameRect.top - 50) + 'px';
        }

        // --- Player Actions ---
        btns.attack.onclick = () => performAction('attack');
        btns.skill.onclick = () => performAction('skill');
        btns.defend.onclick = () => performAction('defend');
        btns.item.onclick = () => performAction('item');

        function performAction(type) {
            if (!isPlayerTurn) return;
            const hero = HEROES[activeHeroId];
            const heroEl = document.getElementById(`hero-${activeHeroId+1}`);
            const enemyEl = document.getElementById('enemy');

            if (type === 'attack') {
                // Animation
                heroEl.style.transform = "translateX(20px)";
                setTimeout(() => heroEl.style.transform = "translateX(0)", 200);

                const dmg = calculateDamage(hero.atk, ENEMY.def, hero.type, ENEMY.type);
                spawnParticles(enemyEl, hero.type === 'Fire' ? 'fire' : 'water', 5);
                dealDamageToEnemy(dmg.amount, dmg.isCrit);
                log(`${hero.name} attacks! ${dmg.amount} dmg.`);
                SoundFX.attack();
            } 
            else if (type === 'skill') {
                hero.mp -= hero.skillCost;
                if (hero.name === "Solarion") {
                    const baseDmg = hero.atk * 1.8; 
                    const dmg = calculateDamage(baseDmg, ENEMY.def, "Fire", ENEMY.type); 
                    spawnParticles(enemyEl, 'fire', 15); // Lots of fire
                    dealDamageToEnemy(dmg.amount, dmg.isCrit);
                    log(`Solarion casts Fireball! ${dmg.amount} dmg.`);
                    SoundFX.fireball();
                } else {
                    HEROES.forEach(h => {
                        if (!h.dead) {
                            const heal = 30;
                            h.hp = Math.min(h.maxHp, h.hp + heal);
                            spawnFloatingText(document.getElementById(`hero-${h.id+1}`), `+${heal}`, 'heal');
                            spawnParticles(document.getElementById(`hero-${h.id+1}`), 'heal', 5);
                        }
                    });
                    log(`Hydro heals the party!`);
                    SoundFX.heal();
                }
            }
            else if (type === 'defend') {
                hero.defending = true;
                spawnFloatingText(heroEl, "Shield!", 'normal');
                log(`${hero.name} defends.`);
                SoundFX.playTone(200, 'triangle', 0.1);
            }
            else if (type === 'item') {
                hero.hp = Math.min(hero.maxHp, hero.hp + 40);
                spawnFloatingText(heroEl, "+40", 'heal');
                log(`${hero.name} used Potion.`);
                SoundFX.heal();
            }

            disableButtons(true);
            updateUI();
            setTimeout(nextTurn, 1000);
        }

        // --- Enemy AI ---
        function enemyAI() {
            const livingHeroes = HEROES.filter(h => !h.dead);
            if (livingHeroes.length === 0) return nextTurn();

            const target = livingHeroes[Math.floor(Math.random() * livingHeroes.length)];
            const targetEl = document.getElementById(`hero-${target.id+1}`);
            const enemyEl = document.getElementById('enemy');

            // Lunge Anim
            enemyEl.style.transform = "translateX(-30px) scale(1.1)";
            setTimeout(() => enemyEl.style.transform = "translateX(0) scale(1)", 200);

            let rawDmg = ENEMY.atk;
            if (target.type === "Water" && ENEMY.type === "Nature") rawDmg *= 1.5;
            if (target.type === "Fire" && ENEMY.type === "Water") rawDmg *= 1.5;

            let finalDmg = Math.max(1, rawDmg - target.def);
            if (target.defending) finalDmg = Math.floor(finalDmg / 2);
            finalDmg += Math.floor(Math.random() * 4) - 2; // Variance

            // Apply
            setTimeout(() => {
                target.hp -= finalDmg;
                triggerHit(targetEl);
                spawnFloatingText(targetEl, finalDmg, 'normal');
                SoundFX.attack();
                log(`${ENEMY.name} hits ${target.name} for ${finalDmg} dmg!`);

                if (target.hp <= 0) {
                    target.hp = 0;
                    target.dead = true;
                    targetEl.classList.add('dead-anim');
                    log(`${target.name} fell!`);
                }
                updateUI();
                setTimeout(nextTurn, 1000);
            }, 250);
        }

        // --- Mechanics ---
        function calculateDamage(atk, def, atkType, defType) {
            let mult = 1.0;
            // Fire > Nature > Water > Fire
            if (atkType === "Fire" && defType === "Nature") mult = 1.5;
            if (atkType === "Nature" && defType === "Water") mult = 1.5;
            if (atkType === "Water" && defType === "Fire") mult = 1.5;
            if (atkType === "Fire" && defType === "Water") mult = 0.7; // Resist

            let isCrit = Math.random() < 0.15;
            if (isCrit) mult *= 1.5;

            let val = (atk * mult) - (def * 0.5);
            val = Math.max(1, Math.floor(val * (0.9 + Math.random() * 0.2))); // +/- 10%
            
            return { amount: val, isCrit: isCrit };
        }

        function dealDamageToEnemy(amount, isCrit) {
            ENEMY.hp -= amount;
            const el = document.getElementById('enemy');
            triggerHit(el);
            spawnFloatingText(el, amount, isCrit ? 'crit' : 'normal');
            if(isCrit) SoundFX.crit();
            updateUI();
        }

        function handleWaveClear() {
            if (currentWave >= WAVES.length - 1) {
                // Victory
                SoundFX.victory();
                document.getElementById('game-over-overlay').style.display = 'flex';
                document.getElementById('game-over-title').innerText = "VICTORY!";
                document.getElementById('game-over-sub').innerText = "You saved the Battle Realms!";
            } else {
                // Next Wave
                SoundFX.victory(); // Small victory
                document.getElementById('wave-overlay').style.display = 'flex';
            }
        }

        function startNextWave() {
            document.getElementById('wave-overlay').style.display = 'none';
            
            // Level Up / Restore
            HEROES.forEach(h => {
                if(h.dead) { h.dead = false; h.hp = Math.floor(h.maxHp * 0.3); } // Revive with 30%
                else { h.hp = h.maxHp; } // Full heal
                h.mp = h.maxMp;
                h.atk += 2; // Stat boost
                document.getElementById(`hero-${h.id+1}`).classList.remove('dead-anim');
            });

            log("Party Rested! Stats Increased.", "green");
            setupWave(currentWave + 1);
        }

        function handleDefeat() {
            document.getElementById('game-over-overlay').style.display = 'flex';
            document.getElementById('game-over-title').innerText = "DEFEAT";
            document.getElementById('game-over-title').style.color = "#d94e41";
            document.getElementById('game-over-sub').innerText = "The Golems prevail...";
        }

        // --- Visual Effects System ---
        function triggerHit(el) {
            el.classList.add('hit-anim');
            setTimeout(() => el.classList.remove('hit-anim'), 400);
        }

        function spawnFloatingText(targetEl, text, type) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = `damage-text ${type}-text`;
            
            const rect = targetEl.getBoundingClientRect();
            const gameRect = document.getElementById('game-window').getBoundingClientRect();
            
            el.style.left = (rect.left - gameRect.left + 20) + 'px';
            el.style.top = (rect.top - gameRect.top) + 'px';
            
            document.getElementById('game-window').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function spawnParticles(targetEl, type, count) {
            const rect = targetEl.getBoundingClientRect();
            const gameRect = document.getElementById('game-window').getBoundingClientRect();
            const centerX = rect.left - gameRect.left + rect.width / 2;
            const centerY = rect.top - gameRect.top + rect.height / 2;

            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                
                // Color & Size
                let size = 5 + Math.random() * 5;
                let color = type === 'fire' ? '#ffaa00' : (type === 'heal' ? '#5eff79' : '#88ccff');
                if(type === 'fire') p.style.boxShadow = "0 0 5px orange";

                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.backgroundColor = color;
                p.style.left = centerX + 'px';
                p.style.top = centerY + 'px';
                
                // Physics
                const angle = Math.random() * Math.PI * 2;
                const velocity = 2 + Math.random() * 4;
                const tx = Math.cos(angle) * 50 * velocity;
                const ty = Math.sin(angle) * 50 * velocity;

                p.style.transition = "all 0.6s ease-out";
                document.getElementById('game-window').appendChild(p);

                // Animate
                requestAnimationFrame(() => {
                    p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
                    p.style.opacity = 0;
                });

                setTimeout(() => p.remove(), 600);
            }
        }

        // --- Helpers ---
        function updateUI() {
            HEROES.forEach((h, i) => {
                const el = document.getElementById(`hero-${i+1}`);
                el.querySelector('.hp-fill').style.width = (h.hp / h.maxHp * 100) + "%";
                el.querySelector('.mp-fill').style.width = (h.mp / h.maxMp * 100) + "%";
            });
            
            if (ENEMY) {
                const el = document.getElementById('enemy');
                el.querySelector('.hp-fill').style.width = Math.max(0, (ENEMY.hp / ENEMY.maxHp * 100)) + "%";
            }
        }

        function log(msg, color) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `> ${msg}`;
            if(color) div.style.color = color;
            logEl.prepend(div);
        }

        function disableButtons(bool) {
            Object.values(btns).forEach(b => b.disabled = bool);
        }

        function showTip(text) { tooltipEl.innerText = text; }
        function clearTip() { tooltipEl.innerText = "Hover for info"; }
        
        // Initial Render
        updateUI();

    </script>
</body>
</html>